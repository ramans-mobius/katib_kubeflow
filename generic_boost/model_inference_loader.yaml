name: Model Inference Loader
description: Loads trained model and preprocessing pipeline for inference
inputs:
  - name: trained_model
    type: Model
    description: Trained boosting model
  - name: preprocessing_pipeline
    type: Model
    description: Preprocessing pipeline
  - name: new_data
    type: Dataset
    description: New data for inference
outputs:
  - name: preprocessed_data
    type: Dataset
    description: Preprocessed data ready for inference
  - name: model_ready
    type: String
    description: Model loading status

implementation:
  container:
    image: nikhilv215/nesy-factory:v22
    command:
      - sh
      - -c
      - |
        set -e
        python3 -c "
        import sys, os, pickle, pandas as pd
        import json
        
        trained_model_path = sys.argv[1]
        preprocessing_path = sys.argv[2]
        new_data_path = sys.argv[3]
        preprocessed_data_path = sys.argv[4]
        model_ready_path = sys.argv[5]
        
        # Load model and preprocessor
        with open(trained_model_path, 'rb') as f:
            model = pickle.load(f)
        
        with open(preprocessing_path, 'rb') as f:
            preprocessor = pickle.load(f)
        
        # Load new data
        new_data = pd.read_csv(new_data_path)
        
        # Apply preprocessing
        preprocessed_data = preprocessor.transform(new_data)
        
        # Save preprocessed data
        with open(preprocessed_data_path, 'wb') as f:
            pickle.dump({
                'preprocessed_data': preprocessed_data,
                'original_data': new_data,
                'model': model
            }, f)
        
        # Save status
        with open(model_ready_path, 'w') as f:
            json.dump({'status': 'ready', 'samples': len(new_data)}, f)
        
        print(f'Loaded model and preprocessed {len(new_data)} samples')
        " \"\$@\"
    args:
      - {inputPath: trained_model}
      - {inputPath: preprocessing_pipeline}
      - {inputPath: new_data}
      - {outputPath: preprocessed_data}
      - {outputPath: model_ready}
