name: 6 CNN Get Data Through CDN
description: Downloads image dataset from CDN URL
inputs:
  - name: process_data_url
    type: String
    description: URL to fetch the image dataset from
outputs:
  - name: processed_data_path
    type: String
    description: Path to downloaded dataset file

implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        set -e
        python3 -m pip install --quiet requests
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse, os, requests, json

        parser = argparse.ArgumentParser()
        parser.add_argument('--process_data_url', type=str, required=True)
        parser.add_argument('--processed_data_path', type=str, required=True)
        args = parser.parse_args()

        args.process_data_url = args.process_data_url.replace("$$", "$$$")

        print("Fetching image dataset from CDN: " + args.process_data_url)
        resp = requests.get(args.process_data_url)
        resp.raise_for_status()

        # Create the output directory if it doesn't exist
        output_dir = os.path.dirname(args.processed_data_path)
        os.makedirs(output_dir, exist_ok=True)

        # Save the downloaded data directly to the output path
        with open(args.processed_data_path, "wb") as f:
            f.write(resp.content)

        # Also save to a known path for reference
        data_file_path = "/tmp/downloaded_data.pkl"
        with open(data_file_path, "wb") as f:
            f.write(resp.content)

        # Write the known path to the output file
        with open(args.processed_data_path, "w") as f:
            f.write(data_file_path)
        
        print("Image dataset saved at " + data_file_path)
        print("Path output written to: " + args.processed_data_path)
    args:
      - --process_data_url
      - { inputValue: process_data_url }
      - --processed_data_path
      - { outputPath: processed_data_path }
