name: 1 Debug Data Structure
description: Downloads and analyzes data.txt structure with extensive debugging
inputs:
  - name: cdn_url
    type: String
    description: URL to fetch the data.txt file from
  - name: dataset_name
    type: String
    description: Target dataset name to analyze
outputs:
  - name: raw_content
    type: String
    description: Original data.txt content
  - name: debug_info
    type: String
    description: Debug information about file structure
  - name: structure_report
    type: String
    description: Detailed structure analysis report
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        set -e
        python3 -m pip install --quiet requests pandas numpy
        python3 -c "
        import sys, os, requests, json, pandas as pd, numpy as np, urllib.parse
        
        print('Number of arguments:', len(sys.argv))
        print('Arguments:', sys.argv)
        
        cdn_url = sys.argv[1]
        dataset_name = sys.argv[2]
        raw_content_path = sys.argv[3]
        debug_info_path = sys.argv[4]
        structure_report_path = sys.argv[5]
        
        print('Starting data structure analysis...')
        print(f'cdn_url: {cdn_url}')
        print(f'dataset_name: {dataset_name}')
        
        decoded_url = urllib.parse.unquote(cdn_url)
        print(f'Fetching data from: {decoded_url}')
        response = requests.get(decoded_url)
        response.raise_for_status()
        raw_content = response.text
        
        os.makedirs(os.path.dirname(raw_content_path) or '.', exist_ok=True)
        with open(raw_content_path, 'w') as f:
            f.write(raw_content)
        
        lines = raw_content.split('\n')
        debug_info = {
            'total_lines': len(lines),
            'file_size_bytes': len(raw_content),
            'dataset_target': dataset_name,
            'first_5_lines': lines[:5],
            'last_5_lines': lines[-5:] if len(lines) > 5 else lines
        }
        
        structure_report = {
            'dataset_locations': [],
            'format_detection': {},
            'parsing_attempts': []
        }
        
        for i, line in enumerate(lines):
            if dataset_name in line:
                structure_report['dataset_locations'].append({
                    'line_number': i,
                    'content_preview': line[:200]
                })
        
        os.makedirs(os.path.dirname(debug_info_path) or '.', exist_ok=True)
        with open(debug_info_path, 'w') as f:
            json.dump(debug_info, f)
        
        os.makedirs(os.path.dirname(structure_report_path) or '.', exist_ok=True)
        with open(structure_report_path, 'w') as f:
            json.dump(structure_report, f)
        
        print('Data structure analysis completed successfully')
        " "$0" "$1" "$2" "$3" "$4" "$5"
    args:
      - {inputValue: cdn_url}
      - {inputValue: dataset_name}
      - {outputPath: raw_content}
      - {outputPath: debug_info}
      - {outputPath: structure_report}
